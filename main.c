#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#include "includes/algorithms.h"
#include "includes/benchmark.h"
#include "includes/fhandle.h"
#include "includes/utils.h"

extern unsigned long long MAX_RAND;
extern short multiplier;
extern char* file_name;
extern int* (*alg_fs[ALGO_COUNT])(int*);
extern short benchmark_mode;
extern int* dataset;
extern int* random_arr;
extern FILE* file;
extern int* (*algorithm)(int*);
extern int dataset_size;
extern int ra_size;

int main(int argc, char** argv) {

	alg_fs[0] = shell_sort;
	alg_fs[1] = insertion_sort;

	multiplier = 1;
	benchmark_mode = 0;
	MAX_RAND = RAND_MAX;

	for (int i = 1; i < argc; i++) {

		printf("i = %d: %s\n", i, argv[i]);

		if (!strcmp(argv[i], "-a") || !strcmp(argv[i], "--algorithm")) {

			// check is next arg possible algorithm and make variable for it
			if ((i + 1) < argc) {

				if (!(algorithm = return_algo(argv[i + 1]))){

					printf("Parameter after %s should be a valid algorithm. For exmaples check --help.\n", argv[i]);
					return 0;
				}

				i++;
			}

			else {

				printf("Parameter after %s should be a valid algorithm. For exmaples check --help.\n", argv[i]);
				return 0;
			}
		}

		else if (!strcmp(argv[i], "-b") || !strcmp(argv[i], "--benchmark")) {

			benchmark_mode = 1;
		}

		else if (!strcmp(argv[i], "--dataset")) {

			// set dataset for benchmark

			dataset_size = 1;

			dataset = (int*)malloc(sizeof(int));

			while ((i + dataset_size) < argc && (dataset[dataset_size - 1] = return_num(argv[i + dataset_size], strlen(argv[i + dataset_size])))) {

				dataset = (int*)realloc(dataset, dataset_size++);
			}

			if (dataset_size == 1) {

				printf("You must specify at least 1 not nil number after %s parameter.\n", argv[i]);
				return 0;
			}

			else {

				i += dataset_size;
			}

		}

		else if (!strcmp(argv[i], "-f") || !strcmp(argv[i], "--file")) {

			// check is next arg an existing file

			if ((i + 1) < argc) {

				file_name = argv[i + 1];

				FILE* file = fopen(file_name, "w+");

				if (!file) {

					printf("File with provided filename doesn\'t exist or can\'t be opened.\n");
					return 0;
				}

				i++;

				// call a function from fhandle.c to read from file
			}

			else {

				printf("Parameter after %s should be a valid filename. For more information check --help.\n", argv[i]);
				return 0;
			}


		}

		else if (!strcmp(argv[i], "-h") || !strcmp(argv[i], "--help")) {

			// help option

			printf("Manual for program.\n");
			printf("Usage options:\n");
			printf("\t-a, --algorithm [ shell_sort, shellsort, shell, insertion_sort, insertionsort, insertion ] - parameter used for setting sorting algorithm.\n");
			printf("\t-b, --benchmark - this parameter setting benchmark program mode. Should be used with --dataset parameter to set count of numbers being generated in temp file and sorted.\n");
			printf("\t\tProgram will be tested with all available algorithms.\n");
			printf("\t--dataset [ N1, N2, ... ] - used for setting count of integers will be generated to make a benchmark. Will be generated N1 integers for first test, N2 integers for second test etc.\n");
			printf("\t-f, --file [ filename ] - setting name of file with numbers that will be sorted. Program puts sorted list in this file. Cannot be used with -b parameter.\n");
			printf("\t-m, --max-num [ N ] - setting max number that can be generated by a program.\n");
			printf("\t-n, --no-sort [ N ] - with this parameter program will generate file with integers, but will not sort it. Should be used with one value - number of integers in new file. Can be used with -f parameter.\n");
			printf("\t-r, --reverse - setting reverse sorting mode.\n");
			printf("\t-h, --help - display this manual.\n");

			return 0;
		}

		else if (!strcmp(argv[i], "-m") || !strcmp(argv[i], "--max-num")) {

			// set maximum random generated number, default is RAND_MAX constant = 2147483647

			if ((i + 1) < argc && return_num(argv[i + 1], strlen(argv[i + 1]))) {

				MAX_RAND = return_num(argv[i + 1], strlen(argv[i + 1]));

				if (!return_num(argv[i + 1], strlen(argv[i + 1]))) {

					printf("Parameter after %s should be a valid number. For more information check --help.\n", argv[i]);
					return 0;
				}


				i++;

			}

			else {

				printf("Parameter after %s should be a valid number. For more information check --help.\n", argv[i]);
				return 0;
			}

		}

		else if (!strcmp(argv[i], "-n") || !strcmp(argv[i], "--no-sort")) {

			// generate file with random numbers without sorting

			if ((i + 1) < argc && (ra_size = return_num(argv[i + 1], sizeof(argv[i + 1])))) {
				
				random_arr = get_random_array(ra_size);
				i++;
			}

			else {

				printf("Parameter after %s should be a valid number. For more information check --help.\n", argv[i]);
			}
		}

		else if (!strcmp(argv[i], "-r") || !strcmp(argv[i], "--reverse")) {

			// set reverse flag
			multiplier = -1;
		}

		else {

			printf("Unknown option, use --help for more information.\n");
			return 0;
		}
	}

	dump_all();


	return 0;
}